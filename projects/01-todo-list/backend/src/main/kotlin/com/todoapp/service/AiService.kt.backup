package com.todoapp.service

/**
 * AI ê¸°ë°˜ ëª©í‘œ ë¶„í•´ ë° í•™ìŠµ ê³„íš ìƒì„± ì„œë¹„ìŠ¤
 */

import com.todoapp.models.*
import io.ktor.client.*
import io.ktor.client.call.*
import io.ktor.client.engine.cio.*
import io.ktor.client.plugins.contentnegotiation.*
import io.ktor.client.request.*
import io.ktor.http.*
import io.ktor.serialization.kotlinx.json.*
import kotlinx.datetime.*
import kotlinx.serialization.Serializable
import kotlinx.serialization.json.Json
import java.util.*

class AiService {
    private val httpClient = HttpClient(CIO) {
        install(ContentNegotiation) {
            json(Json {
                ignoreUnknownKeys = true
                isLenient = true
            })
        }
    }

    // ì„ì‹œë¡œ OpenAI API í‚¤ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬)
    private val openAiApiKey = System.getenv("OPENAI_API_KEY") 
        ?: "demo-key" // ë°ëª¨ìš© (ì‹¤ì œë¡œëŠ” í™˜ê²½ë³€ìˆ˜ í•„ìˆ˜)

    /**
     * AIë¥¼ ì‚¬ìš©í•´ ëª©í‘œë¥¼ ì„¸ë¶„í™”ëœ í•™ìŠµ ê³„íšìœ¼ë¡œ ë³€í™˜
     */
    suspend fun generateLearningPlan(request: AiGoalBreakdownRequest, userId: String): AiLearningPlan {
        return if (openAiApiKey == "demo-key") {
            // ë°ëª¨ ëª¨ë“œ: ì‹¤ì œ AI ëŒ€ì‹  ë¯¸ë¦¬ ì •ì˜ëœ ê³„íš ë°˜í™˜
            generateDemoLearningPlan(request, userId)
        } else {
            // ì‹¤ì œ AI API í˜¸ì¶œ
            generateRealLearningPlan(request, userId)
        }
    }

    /**
     * ì‹¤ì œ OpenAI APIë¥¼ ì‚¬ìš©í•œ í•™ìŠµ ê³„íš ìƒì„±
     */
    private suspend fun generateRealLearningPlan(request: AiGoalBreakdownRequest, userId: String): AiLearningPlan {
        val prompt = AiPromptTemplates.createGoalBreakdownPrompt(request)
        
        val openAiRequest = OpenAiRequest(
            model = "gpt-4o-mini",
            messages = listOf(
                OpenAiMessage(
                    role = "system",
                    content = """ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ í•™ìŠµ ê³„íš ìˆ˜ë¦½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
                    ì‚¬ìš©ìì˜ ëª©í‘œë¥¼ ë¶„ì„í•˜ì—¬ ë‹¬ì„± ê°€ëŠ¥í•œ ë‹¨ê³„ë³„ í•™ìŠµ ê³„íšì„ ìˆ˜ë¦½í•´ì£¼ì„¸ìš”.
                    ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ í•´ì£¼ì„¸ìš”."""
                ),
                OpenAiMessage(role = "user", content = prompt)
            ),
            temperature = 0.7,
            maxTokens = 2000
        )

        try {
            val response: OpenAiResponse = httpClient.post("https://api.openai.com/v1/chat/completions") {
                header("Authorization", "Bearer $openAiApiKey")
                header("Content-Type", "application/json")
                setBody(openAiRequest)
            }.body()

            val aiContent = response.choices.firstOrNull()?.message?.content
                ?: throw Exception("AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤")

            // AI ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ í•™ìŠµ ê³„íš ìƒì„±
            return parseAiResponseToLearningPlan(aiContent, request, userId)
            
        } catch (e: Exception) {
            println("OpenAI API í˜¸ì¶œ ì‹¤íŒ¨: ${e.message}")
            // ì‹¤íŒ¨ ì‹œ ë°ëª¨ ê³„íš ë°˜í™˜
            return generateDemoLearningPlan(request, userId)
        }
    }

    /**
     * ë°ëª¨ìš© í•™ìŠµ ê³„íš ìƒì„± (AI API ì—†ì´ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
     */
    private fun generateDemoLearningPlan(request: AiGoalBreakdownRequest, userId: String): AiLearningPlan {
        val planId = UUID.randomUUID().toString()
        val now = Clock.System.now().toLocalDateTime(kotlinx.datetime.TimeZone.UTC)

        // ëª©í‘œì— ë”°ë¥¸ ë§ì¶¤í˜• ê³„íš ìƒì„±
        val phases = when {
            request.goalTitle.contains("React", ignoreCase = true) -> createReactLearningPhases()
            request.goalTitle.contains("Python", ignoreCase = true) -> createPythonLearningPhases()
            request.goalTitle.contains("ì•Œê³ ë¦¬ì¦˜", ignoreCase = true) -> createAlgorithmLearningPhases()
            request.goalTitle.contains("ì›¹", ignoreCase = true) -> createWebLearningPhases()
            else -> createGeneralLearningPhases(request.goalTitle)
        }

        return AiLearningPlan(
            id = planId,
            originalGoal = request.goalTitle,
            totalEstimatedHours = phases.sumOf { it.estimatedHours },
            estimatedWeeks = (phases.sumOf { it.estimatedHours } / request.availableHoursPerWeek) + 1,
            phases = phases,
            prerequisites = getPrerequisites(request.goalTitle),
            recommendedResources = getRecommendedResources(request.goalTitle),
            createdAt = now,
            createdBy = userId
        )
    }

    /**
     * React í•™ìŠµ ê³„íš ìƒì„±
     */
    private fun createReactLearningPhases(): List<LearningPhase> {
        return listOf(
            LearningPhase(
                id = UUID.randomUUID().toString(),
                phaseNumber = 1,
                title = "React ê¸°ì´ˆ ê°œë… ì´í•´",
                description = "Reactì˜ í•µì‹¬ ê°œë…ê³¼ ê¸°ë³¸ ë¬¸ë²•ì„ ìµí™ë‹ˆë‹¤",
                estimatedHours = 10,
                estimatedDays = 7,
                difficulty = TaskDifficulty.EASY,
                milestones = listOf(
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "React ê°œë… ì´í•´",
                        description = "ì»´í¬ë„ŒíŠ¸, JSX, Virtual DOM ê°œë… í•™ìŠµ",
                        estimatedHours = 3.0f,
                        type = MilestoneType.LEARNING,
                        order = 1
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "ì²« ë²ˆì§¸ ì»´í¬ë„ŒíŠ¸ ë§Œë“¤ê¸°",
                        description = "ê°„ë‹¨í•œ Hello World ì»´í¬ë„ŒíŠ¸ ì‘ì„±",
                        estimatedHours = 2.0f,
                        type = MilestoneType.PRACTICE,
                        order = 2
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "JSX ë¬¸ë²• ì—°ìŠµ",
                        description = "JSX ë¬¸ë²•ì„ ì‚¬ìš©í•œ ë‹¤ì–‘í•œ ì˜ˆì œ ì‘ì„±",
                        estimatedHours = 5.0f,
                        type = MilestoneType.PRACTICE,
                        order = 3
                    )
                ),
                skills = listOf("React ê¸°ì´ˆ", "JSX", "ì»´í¬ë„ŒíŠ¸")
            ),
            LearningPhase(
                id = UUID.randomUUID().toString(),
                phaseNumber = 2,
                title = "Propsì™€ State ë§ˆìŠ¤í„°",
                description = "ì»´í¬ë„ŒíŠ¸ ê°„ ë°ì´í„° ì „ë‹¬ê³¼ ìƒíƒœ ê´€ë¦¬ë¥¼ í•™ìŠµí•©ë‹ˆë‹¤",
                estimatedHours = 15,
                estimatedDays = 10,
                difficulty = TaskDifficulty.MODERATE,
                milestones = listOf(
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "Props ì‚¬ìš©ë²• ìµíˆê¸°",
                        description = "ë¶€ëª¨ì—ì„œ ìì‹ìœ¼ë¡œ ë°ì´í„° ì „ë‹¬",
                        estimatedHours = 4.0f,
                        type = MilestoneType.LEARNING,
                        order = 1
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "State ê´€ë¦¬í•˜ê¸°",
                        description = "useState í›…ì„ ì‚¬ìš©í•œ ìƒíƒœ ê´€ë¦¬",
                        estimatedHours = 6.0f,
                        type = MilestoneType.PRACTICE,
                        order = 2
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "ì´ë²¤íŠ¸ ì²˜ë¦¬í•˜ê¸°",
                        description = "í´ë¦­, ì…ë ¥ ë“± ì‚¬ìš©ì ì´ë²¤íŠ¸ ì²˜ë¦¬",
                        estimatedHours = 5.0f,
                        type = MilestoneType.PRACTICE,
                        order = 3
                    )
                ),
                skills = listOf("Props", "State", "ì´ë²¤íŠ¸ ì²˜ë¦¬")
            ),
            LearningPhase(
                id = UUID.randomUUID().toString(),
                phaseNumber = 3,
                title = "ì‹¤ì „ í”„ë¡œì íŠ¸ êµ¬í˜„",
                description = "Todo ì•±ì„ ë§Œë“¤ì–´ ë°°ìš´ ë‚´ìš©ì„ ì‹¤ì œë¡œ ì ìš©í•©ë‹ˆë‹¤",
                estimatedHours = 25,
                estimatedDays = 21,
                difficulty = TaskDifficulty.HARD,
                milestones = listOf(
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "í”„ë¡œì íŠ¸ ì„¤ê³„",
                        description = "ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°ì™€ ë°ì´í„° íë¦„ ì„¤ê³„",
                        estimatedHours = 3.0f,
                        type = MilestoneType.PROJECT,
                        order = 1
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "ê¸°ë³¸ ê¸°ëŠ¥ êµ¬í˜„",
                        description = "í• ì¼ ì¶”ê°€, ì‚­ì œ, ìˆ˜ì • ê¸°ëŠ¥ êµ¬í˜„",
                        estimatedHours = 12.0f,
                        type = MilestoneType.PROJECT,
                        order = 2
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "ê³ ê¸‰ ê¸°ëŠ¥ ì¶”ê°€",
                        description = "í•„í„°ë§, ì •ë ¬, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë“±",
                        estimatedHours = 10.0f,
                        type = MilestoneType.PROJECT,
                        order = 3
                    )
                ),
                skills = listOf("í”„ë¡œì íŠ¸ ì„¤ê³„", "ìƒíƒœ ê´€ë¦¬", "ìµœì í™”")
            )
        )
    }

    /**
     * Python í•™ìŠµ ê³„íš ìƒì„±
     */
    private fun createPythonLearningPhases(): List<LearningPhase> = emptyList()

    /**
     * ì•Œê³ ë¦¬ì¦˜ í•™ìŠµ ê³„íš ìƒì„±
     */
    private fun createAlgorithmLearningPhases(): List<LearningPhase> = emptyList()

    /**
     * ì›¹ ê°œë°œ í•™ìŠµ ê³„íš ìƒì„±
     */
    private fun createWebLearningPhases(): List<LearningPhase> = emptyList()

    /**
     * ì¼ë°˜ì ì¸ í•™ìŠµ ê³„íš ìƒì„±
     */
    private fun createGeneralLearningPhases(goalTitle: String): List<LearningPhase> {
        return listOf(
            LearningPhase(
                id = UUID.randomUUID().toString(),
                phaseNumber = 1,
                title = "$goalTitle ê¸°ì´ˆ ì´í•´",
                description = "ê¸°ë³¸ ê°œë…ê³¼ í•µì‹¬ ì›ë¦¬ë¥¼ í•™ìŠµí•©ë‹ˆë‹¤",
                estimatedHours = 10,
                estimatedDays = 7,
                difficulty = TaskDifficulty.EASY,
                milestones = listOf(
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "ê¸°ë³¸ ê°œë… í•™ìŠµ",
                        description = "í•µì‹¬ ìš©ì–´ì™€ ê°œë… ì´í•´",
                        estimatedHours = 4.0f,
                        type = MilestoneType.LEARNING,
                        order = 1
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "ì‹¤ìŠµ ì˜ˆì œ",
                        description = "ê°„ë‹¨í•œ ì˜ˆì œë¥¼ ë”°ë¼í•´ë³´ê¸°",
                        estimatedHours = 6.0f,
                        type = MilestoneType.PRACTICE,
                        order = 2
                    )
                ),
                skills = listOf("ê¸°ì´ˆ ê°œë…", "ê¸°ë³¸ ì‹¤ìŠµ")
            ),
            LearningPhase(
                id = UUID.randomUUID().toString(),
                phaseNumber = 2,
                title = "$goalTitle ì‹¤ì „ ì ìš©",
                description = "ë°°ìš´ ë‚´ìš©ì„ ì‹¤ì œ í”„ë¡œì íŠ¸ì— ì ìš©í•©ë‹ˆë‹¤",
                estimatedHours = 20,
                estimatedDays = 14,
                difficulty = TaskDifficulty.MODERATE,
                milestones = listOf(
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "í”„ë¡œì íŠ¸ ê¸°íš",
                        description = "ëª©í‘œì™€ ë²”ìœ„ ì„¤ì •",
                        estimatedHours = 3.0f,
                        type = MilestoneType.PROJECT,
                        order = 1
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "êµ¬í˜„ ë° í…ŒìŠ¤íŠ¸",
                        description = "ì‹¤ì œ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°",
                        estimatedHours = 15.0f,
                        type = MilestoneType.PROJECT,
                        order = 2
                    ),
                    PhaseMilestone(
                        id = UUID.randomUUID().toString(),
                        title = "ì™„ì„± ë° ë°°í¬",
                        description = "ìµœì¢… ì™„ì„±ê³¼ ê³µìœ ",
                        estimatedHours = 2.0f,
                        type = MilestoneType.PROJECT,
                        order = 3
                    )
                ),
                skills = listOf("í”„ë¡œì íŠ¸ ê´€ë¦¬", "ì‹¤ì „ ì ìš©")
            )
        )
    }

    /**
     * ëª©í‘œë³„ ì„ ìˆ˜ ì§€ì‹ ë°˜í™˜
     */
    private fun getPrerequisites(goalTitle: String): List<String> {
        return when {
            goalTitle.contains("React", ignoreCase = true) -> 
                listOf("JavaScript ê¸°ì´ˆ", "HTML/CSS", "ES6+ ë¬¸ë²•")
            goalTitle.contains("Python", ignoreCase = true) -> 
                listOf("í”„ë¡œê·¸ë˜ë° ê¸°ì´ˆ ê°œë…")
            goalTitle.contains("ì•Œê³ ë¦¬ì¦˜", ignoreCase = true) -> 
                listOf("í”„ë¡œê·¸ë˜ë° ì–¸ì–´ ê¸°ì´ˆ", "ìˆ˜í•™ì  ì‚¬ê³ ")
            goalTitle.contains("ì›¹", ignoreCase = true) -> 
                listOf("ì»´í“¨í„° ê¸°ì´ˆ", "ì¸í„°ë„· ì´í•´")
            else -> listOf("ê¸°ì´ˆ ì»´í“¨í„° í™œìš©")
        }
    }

    /**
     * ëª©í‘œë³„ ì¶”ì²œ ìë£Œ ë°˜í™˜
     */
    private fun getRecommendedResources(goalTitle: String): List<ResourceRecommendation> {
        return when {
            goalTitle.contains("React", ignoreCase = true) -> listOf(
                ResourceRecommendation(
                    title = "React ê³µì‹ ë¬¸ì„œ",
                    type = ResourceType.DOCUMENTATION,
                    url = "https://react.dev",
                    description = "Reactì˜ ê³µì‹ ê°€ì´ë“œì™€ API ë¬¸ì„œ",
                    difficulty = TaskDifficulty.MODERATE,
                    estimatedTime = "ì§€ì†ì  ì°¸ì¡°"
                ),
                ResourceRecommendation(
                    title = "React Tutorial",
                    type = ResourceType.TUTORIAL,
                    url = "https://react.dev/learn/tutorial-tic-tac-toe",
                    description = "ê³µì‹ íŠœí† ë¦¬ì–¼ë¡œ í‹±íƒí†  ê²Œì„ ë§Œë“¤ê¸°",
                    difficulty = TaskDifficulty.EASY,
                    estimatedTime = "2-3ì‹œê°„"
                )
            )
            goalTitle.contains("Python", ignoreCase = true) -> listOf(
                ResourceRecommendation(
                    title = "Python.org íŠœí† ë¦¬ì–¼",
                    type = ResourceType.TUTORIAL,
                    url = "https://docs.python.org/3/tutorial/",
                    description = "Python ê³µì‹ íŠœí† ë¦¬ì–¼",
                    difficulty = TaskDifficulty.EASY,
                    estimatedTime = "1ì£¼"
                )
            )
            else -> listOf(
                ResourceRecommendation(
                    title = "ê´€ë ¨ ì˜¨ë¼ì¸ ê°•ì˜",
                    type = ResourceType.VIDEO_COURSE,
                    description = "ëª©í‘œì— ë§ëŠ” ì˜¨ë¼ì¸ ê°•ì˜ ìˆ˜ê°•",
                    difficulty = TaskDifficulty.MODERATE,
                    estimatedTime = "ìˆ˜ê°• ì‹œê°„ì— ë”°ë¼"
                )
            )
        }
    }

    /**
     * AI ì‘ë‹µì„ í•™ìŠµ ê³„íšìœ¼ë¡œ íŒŒì‹± (ì‹¤ì œ êµ¬í˜„ì‹œ JSON íŒŒì‹± ë¡œì§ í•„ìš”)
     */
    private fun parseAiResponseToLearningPlan(
        aiContent: String, 
        request: AiGoalBreakdownRequest, 
        userId: String
    ): AiLearningPlan {
        // ì‹¤ì œë¡œëŠ” AI ì‘ë‹µì„ íŒŒì‹±í•˜ëŠ” ë¡œì§ì´ í•„ìš”
        // í˜„ì¬ëŠ” ë°ëª¨ ê³„íš ë°˜í™˜
        return generateDemoLearningPlan(request, userId)
    }

    /**
     * ì¼ì¼ í•™ìŠµ ì¶”ì²œ ìƒì„±
     */
    suspend fun generateDailyRecommendation(
        userId: String, 
        progress: UserProgress, 
        plan: AiLearningPlan,
        availableMinutes: Int
    ): DailyRecommendation {
        val currentPhase = plan.phases.getOrNull(progress.currentPhase - 1)
        val today = Clock.System.todayIn(kotlinx.datetime.TimeZone.UTC)
        
        val recommendedTasks = currentPhase?.milestones
            ?.filter { !progress.completedMilestones.contains(it.id) }
            ?.take(3)
            ?.mapIndexed { index, milestone ->
                RecommendedTask(
                    id = UUID.randomUUID().toString(),
                    title = milestone.title,
                    description = milestone.description,
                    type = milestone.type,
                    estimatedMinutes = (milestone.estimatedHours * 60).toInt(),
                    priority = when (index) {
                        0 -> TaskPriority.HIGH
                        1 -> TaskPriority.MEDIUM
                        else -> TaskPriority.LOW
                    },
                    phaseId = currentPhase.id,
                    milestoneId = milestone.id
                )
            } ?: emptyList()

        return DailyRecommendation(
            id = UUID.randomUUID().toString(),
            userId = userId,
            date = today,
            recommendedTasks = recommendedTasks,
            estimatedTotalTime = recommendedTasks.sumOf { it.estimatedMinutes }.coerceAtMost(availableMinutes),
            focusArea = currentPhase?.title ?: "í•™ìŠµ ê³„íš ê²€í† ",
            motivationalMessage = generateMotivationalMessage(progress),
            generatedAt = Clock.System.now().toLocalDateTime(kotlinx.datetime.TimeZone.UTC)
        )
    }

    /**
     * ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ ìƒì„±
     */
    private fun generateMotivationalMessage(progress: UserProgress): String {
        val progressPercent = (progress.totalProgress * 100).toInt()
        
        return when {
            progressPercent < 10 -> "ìƒˆë¡œìš´ ì‹œì‘! í•œ ê±¸ìŒì”© ë‚˜ì•„ê°€ì„¸ìš” ğŸš€"
            progressPercent < 30 -> "ì¢‹ì€ ì¶œë°œì…ë‹ˆë‹¤! ê¾¸ì¤€í•¨ì´ í˜ì´ì—ìš” ğŸ’ª"
            progressPercent < 50 -> "ë²Œì¨ ${progressPercent}% ì™„ì„±! ì¤‘ê°„ ì§€ì ì„ ë„˜ì—ˆì–´ìš” ğŸ¯"
            progressPercent < 80 -> "ì´ì œ ì–¼ë§ˆ ë‚¨ì§€ ì•Šì•˜ì–´ìš”! ë§ˆì§€ë§‰ ìŠ¤í¼íŠ¸ ğŸ’¨"
            progressPercent < 95 -> "ê±°ì˜ ì™„ì£¼! ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„¸ìš” ğŸ"
            else -> "ì™„ì£¼ë¥¼ ëˆˆì•ì— ë‘ê³  ìˆì–´ìš”! ë§ˆì§€ë§‰ê¹Œì§€ í™”ì´íŒ…! ğŸ‰"
        }
    }
}

// OpenAI API ê´€ë ¨ ë°ì´í„° í´ë˜ìŠ¤ë“¤
@Serializable
data class OpenAiRequest(
    val model: String,
    val messages: List<OpenAiMessage>,
    val temperature: Double = 0.7,
    val maxTokens: Int = 1000
)

@Serializable
data class OpenAiMessage(
    val role: String,
    val content: String
)

@Serializable
data class OpenAiResponse(
    val choices: List<OpenAiChoice>
)

@Serializable
data class OpenAiChoice(
    val message: OpenAiMessage
) 